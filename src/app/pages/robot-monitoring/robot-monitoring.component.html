<div class="robot-monitoring-container">
  <!-- Header Toolbar -->
  <mat-toolbar class="header-toolbar" color="primary">
    <div class="toolbar-left">
      <mat-icon>map</mat-icon>
      <span class="title">Robot Monitoring</span>
    </div>

    <div class="toolbar-center">
      <!-- Map Selector -->
      <mat-form-field appearance="outline" class="map-selector">
        <mat-label>Select Map</mat-label>
        <mat-select [value]="selectedMapId()" (selectionChange)="selectMap($event.value)">
          @for (map of maps(); track map.id) {
            <mat-option [value]="map.id">
              {{ map.name }}
              @if (map.isDefault) {
                <span class="default-badge">(Default)</span>
              }
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <div class="toolbar-right">
      <!-- Add Robot Button with Dropdown -->
      <button mat-icon-button [matMenuTriggerFor]="robotMenu"
              matTooltip="Add robot to map"
              [disabled]="!selectedMap()">
        <mat-icon>add_circle</mat-icon>
      </button>
      <mat-menu #robotMenu="matMenu" class="robot-menu">
        <div class="robot-menu-header" (click)="$event.stopPropagation()">
          <span>Available Robots ({{ allMobileRobots().length }})</span>
          @if (isLoadingRobots() || mobileRobotsService.isSyncing()) {
            <mat-spinner diameter="16"></mat-spinner>
          } @else {
            <button mat-icon-button matTooltip="Sync robots from AMR" (click)="syncAndReloadRobots(); $event.stopPropagation()">
              <mat-icon>sync</mat-icon>
            </button>
          }
        </div>
        @if (availableRobotsToPlace().length === 0) {
          <div class="robot-menu-empty" (click)="$event.stopPropagation()">
            <mat-icon>info</mat-icon>
            @if (allMobileRobots().length === 0) {
              <span>No robots synced. Click sync to load.</span>
            } @else {
              <span>All robots already placed</span>
            }
          </div>
        } @else {
          @for (robot of availableRobotsToPlace(); track robot.robotId) {
            <button mat-menu-item (click)="startRobotPlacement(robot.robotId)">
              <mat-icon>smart_toy</mat-icon>
              <span class="robot-name">{{ robot.robotId }}</span>
              <span class="robot-info">{{ robot.robotTypeCode || 'Unknown' }}</span>
            </button>
          }
        }
      </mat-menu>

      <!-- Placed Robots Count -->
      @if (placedRobots().size > 0) {
        <span class="placed-robots-badge" matTooltip="Robots on map">
          <mat-icon>smart_toy</mat-icon>
          <span>{{ placedRobots().size }}</span>
        </span>

        <button mat-icon-button matTooltip="Fit to robots" (click)="fitToRobots()">
          <mat-icon>gps_fixed</mat-icon>
        </button>

        <button mat-icon-button matTooltip="Remove all robots" (click)="clearAllRobots()">
          <mat-icon>delete_sweep</mat-icon>
        </button>
      }

      <!-- Connection Status -->
      @if (robotRealtimeService.connectionState() === 'connected') {
        <span class="connection-status connected" matTooltip="Connected to robot updates">
          <mat-icon>wifi</mat-icon>
        </span>
      } @else if (robotRealtimeService.connectionState() === 'connecting') {
        <span class="connection-status connecting" matTooltip="Connecting...">
          <mat-icon>wifi_find</mat-icon>
        </span>
      } @else if (selectedMap()) {
        <span class="connection-status disconnected" matTooltip="Not connected">
          <mat-icon>wifi_off</mat-icon>
        </span>
      }

      <mat-divider vertical></mat-divider>

      <button mat-icon-button matTooltip="Fit to content" (click)="fitMapToContent()">
        <mat-icon>fit_screen</mat-icon>
      </button>

      <!-- Map Menu -->
      <button mat-icon-button [matMenuTriggerFor]="mapMenu" matTooltip="Map options">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #mapMenu="matMenu">
        <button mat-menu-item (click)="openCreateMapDialog()">
          <mat-icon>add</mat-icon>
          <span>New Map Configuration</span>
        </button>
        @if (selectedMap()) {
          <button mat-menu-item (click)="openEditMapDialog()">
            <mat-icon>edit</mat-icon>
            <span>Edit Current Map</span>
          </button>
          <mat-divider></mat-divider>
          <button mat-menu-item class="delete-option" (click)="deleteCurrentMap()">
            <mat-icon color="warn">delete</mat-icon>
            <span>Delete Current Map</span>
          </button>
        }
      </mat-menu>
    </div>
  </mat-toolbar>

  <!-- Drawing Toolbar -->
  @if (selectedMap()) {
    <app-drawing-toolbar
      [currentMode]="drawingMode()"
      [isDrawingZone]="isDrawingZone()"
      [hasUnsavedChanges]="hasUnsavedChanges()"
      [disabled]="isLoadingMapData()"
      [availableNodes]="availableNodes()"
      (modeChange)="onDrawingModeChange($event)"
      (finishZone)="onFinishZone()"
      (cancelDrawing)="onCancelDrawing()"
      (uploadImage)="onUploadImage()"
      (save)="onSaveDrawing()"
      (clearAll)="onClearAllDrawing()"
      (placeNode)="onPlaceNodeFromDropdown($event)">
    </app-drawing-toolbar>
  }

  <!-- Main Content -->
  <div class="main-content">
    <!-- Map Container -->
    <div class="map-container">
      @if (isLoadingMapData()) {
        <div class="loading-overlay">
          <mat-spinner diameter="48"></mat-spinner>
          <span>Loading map data...</span>
        </div>
      }

      @if (selectedMap()) {
        <app-robot-map-canvas-v2
          [mapConfig]="selectedMap()"
          [backgroundImageUrl]="backgroundImageUrl()"
          [imageWidth]="imageWidth"
          [imageHeight]="imageHeight"
          [showRobots]="placedRobots().size > 0"
          [placedRobotIds]="placedRobots()"
          [coordinateScale]="1"
          [isDrawingZone]="drawingMode() === 'drawZone'"
          [isDrawingRect]="drawingMode() === 'drawRect'"
          [isConnectingNodes]="drawingMode() === 'drawLine'"
          [customNodes]="customNodes()"
          [customZones]="customZones()"
          [customLines]="customLines()"
          (nodesChange)="onNodesChange($event)"
          (zonesChange)="onZonesChange($event)"
          (linesChange)="onLinesChange($event)"
          (selectionChange)="onSelectionChange($event)">
        </app-robot-map-canvas-v2>

        <!-- Robot Placement Indicator -->
        @if (isPlacingRobot()) {
          <div class="placement-indicator">
            <mat-icon>smart_toy</mat-icon>
            <span>Click a node to place robot {{ selectedRobotToPlace() }}</span>
            <button mat-button color="warn" (click)="cancelRobotPlacement()">Cancel</button>
          </div>
        }
      } @else if (!isLoadingMaps()) {
        <div class="empty-state">
          <mat-icon>map</mat-icon>
          <h3>No Map Selected</h3>
          <p>Select a map configuration or create a new one to get started.</p>
          <button mat-raised-button color="primary" (click)="openCreateMapDialog()">
            <mat-icon>add</mat-icon>
            Create Map Configuration
          </button>
        </div>
      }
    </div>

  </div>
</div>
