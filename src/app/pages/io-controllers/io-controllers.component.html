<div class="io-controllers-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>IO Controllers</h1>
      <span class="subtitle">Manage Modbus IO devices and channels</span>
    </div>
    <div class="header-right">
      <mat-slide-toggle
        [checked]="autoRefresh()"
        (change)="toggleAutoRefresh()"
        color="primary">
        Auto Refresh
      </mat-slide-toggle>
      <button mat-raised-button color="primary" (click)="openAddDeviceDialog()">
        <mat-icon>add</mat-icon>
        Add Device
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Device List (Left Panel) -->
    <div class="device-list-panel">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Devices</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (isLoading()) {
            <div class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
            </div>
          } @else if (devices().length === 0) {
            <div class="empty-state">
              <mat-icon>devices_other</mat-icon>
              <p>No devices configured</p>
              <button mat-stroked-button color="primary" (click)="openAddDeviceDialog()">
                Add Your First Device
              </button>
            </div>
          } @else {
            <div class="device-list">
              @for (device of devices(); track device.id) {
                <div
                  class="device-item"
                  [class.selected]="selectedDeviceId() === device.id"
                  (click)="selectDevice(device)">
                  <div class="device-info">
                    <div class="device-name">{{ device.deviceName }}</div>
                    <div class="device-address">{{ device.ipAddress }}:{{ device.port }}</div>
                  </div>
                  <div class="device-status">
                    <span class="status-indicator" [ngClass]="device.connectionStatusClass"></span>
                    <span class="status-text">{{ device.connectionStatusText }}</span>
                  </div>
                  <div class="device-actions">
                    <button mat-icon-button
                            matTooltip="Test Connection"
                            (click)="testConnection(device, $event)"
                            [disabled]="ioService.isTestingConnection()">
                      <mat-icon>wifi_find</mat-icon>
                    </button>
                    <button mat-icon-button
                            matTooltip="Edit"
                            (click)="openEditDeviceDialog(device, $event)">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button
                            matTooltip="Delete"
                            color="warn"
                            (click)="deleteDevice(device, $event)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Device Detail (Right Panel) -->
    <div class="device-detail-panel">
      @if (!selectedDeviceId()) {
        <mat-card class="no-selection">
          <mat-icon>touch_app</mat-icon>
          <p>Select a device to view its channels</p>
        </mat-card>
      } @else if (selectedDeviceStatus()) {
        <mat-card>
          <mat-card-header>
            <mat-card-title>
              {{ selectedDeviceStatus()!.device.deviceName }}
              @if (selectedDeviceStatus()!.isConnected) {
                <mat-chip color="primary" selected>Connected</mat-chip>
              } @else {
                <mat-chip color="warn">Disconnected</mat-chip>
              }
            </mat-card-title>
            <mat-card-subtitle>
              {{ selectedDeviceStatus()!.device.ipAddress }}:{{ selectedDeviceStatus()!.device.port }}
              &bull; Unit ID: {{ selectedDeviceStatus()!.device.unitId }}
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <mat-tab-group animationDuration="200ms">
              <!-- Channel Setting Tab -->
              <mat-tab>
                <ng-template mat-tab-label>
                  <mat-icon class="tab-icon">settings_input_component</mat-icon>
                  Channel Setting
                </ng-template>

                <div class="channel-setting-view">
                  <!-- Digital Inputs -->
                  <div class="channel-section">
                    <h3>Digital Inputs (DI 0-7)</h3>
                    <div class="channel-grid">
                      @for (channel of digitalInputs(); track channel.id) {
                        <div class="channel-card di">
                          <div class="channel-header">
                            <span class="channel-name">{{ channel.channelLabel }}</span>
                          </div>
                          <div class="channel-indicator" [ngClass]="channel.stateClass">
                            {{ channel.stateText }}
                          </div>
                        </div>
                      }
                    </div>
                  </div>

                  <mat-divider></mat-divider>

                  <!-- Digital Outputs -->
                  <div class="channel-section">
                    <h3>Digital Outputs (DO 0-7)</h3>
                    <div class="channel-grid">
                      @for (channel of digitalOutputs(); track channel.id) {
                        <div class="channel-card do">
                          <div class="channel-header">
                            <span class="channel-name">{{ channel.channelLabel }}</span>
                            <mat-slide-toggle
                              [checked]="channel.currentState"
                              (change)="toggleDO(channel)"
                              color="primary"
                              matTooltip="Toggle Output">
                            </mat-slide-toggle>
                          </div>
                          <div class="channel-indicator" [ngClass]="channel.stateClass">
                            {{ channel.stateText }}
                          </div>
                          <div class="channel-fsv">
                            <mat-slide-toggle
                              [checked]="channel.fsvEnabled"
                              (change)="toggleFsv(channel, $event)"
                              color="accent"
                              matTooltip="Fail-Safe Value">
                              FSV
                            </mat-slide-toggle>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </mat-tab>

              <!-- Modbus Tab -->
              <mat-tab>
                <ng-template mat-tab-label>
                  <mat-icon class="tab-icon">table_chart</mat-icon>
                  Modbus
                </ng-template>

                <div class="modbus-view">
                  <table mat-table [dataSource]="selectedChannels()" class="modbus-table">
                    <!-- Location Column -->
                    <ng-container matColumnDef="location">
                      <th mat-header-cell *matHeaderCellDef>Location</th>
                      <td mat-cell *matCellDef="let channel">{{ channel.modbusAddress }}</td>
                    </ng-container>

                    <!-- Type Column -->
                    <ng-container matColumnDef="type">
                      <th mat-header-cell *matHeaderCellDef>Type</th>
                      <td mat-cell *matCellDef="let channel">Bit</td>
                    </ng-container>

                    <!-- Value Column -->
                    <ng-container matColumnDef="value">
                      <th mat-header-cell *matHeaderCellDef>Value</th>
                      <td mat-cell *matCellDef="let channel">
                        <span [ngClass]="channel.stateClass">{{ channel.currentState ? '1' : '0' }}</span>
                      </td>
                    </ng-container>

                    <!-- Description Column -->
                    <ng-container matColumnDef="description">
                      <th mat-header-cell *matHeaderCellDef>Description</th>
                      <td mat-cell *matCellDef="let channel">{{ channel.channelLabel }}</td>
                    </ng-container>

                    <!-- Mode Column -->
                    <ng-container matColumnDef="mode">
                      <th mat-header-cell *matHeaderCellDef>Mode</th>
                      <td mat-cell *matCellDef="let channel">
                        {{ channel.channelType === 'DigitalInput' ? 'DI' : 'DO' }}
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="modbusColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: modbusColumns;"></tr>
                  </table>
                </div>
              </mat-tab>
            </mat-tab-group>
          </mat-card-content>
        </mat-card>
      }
    </div>
  </div>
</div>
