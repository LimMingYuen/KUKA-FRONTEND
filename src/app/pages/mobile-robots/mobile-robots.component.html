<!-- Page Header -->
<div class="page-header">
  <div class="header-left">
    <h1 class="page-title">
      <mat-icon class="title-icon">smart_toy</mat-icon>
      Mobile Robots Management
    </h1>
    <span class="robot-count-badge">{{ mobileRobots.length }} robots</span>
  </div>
  <div class="header-actions">
    <button mat-icon-button
            (click)="refreshMobileRobots()"
            matTooltip="Refresh robots"
            [disabled]="isLoading">
      <mat-icon>refresh</mat-icon>
    </button>
    <button mat-raised-button
            color="primary"
            (click)="syncMobileRobots()"
            [disabled]="isSyncing"
            matTooltip="Sync robots from external system">
      <mat-icon>sync</mat-icon>
      <span class="button-text">{{ isSyncing ? 'Syncing...' : 'Sync Robots' }}</span>
      <mat-spinner *ngIf="isSyncing" diameter="20" class="button-spinner"></mat-spinner>
    </button>
  </div>
</div>

<!-- Search Bar -->
<div class="search-section">
  <mat-form-field class="search-field" appearance="outline">
    <mat-label>Search robots by ID, type, status, map code...</mat-label>
    <input matInput
           [(ngModel)]="searchTerm"
           (ngModelChange)="onSearchChange()"
           placeholder="Type to search...">
    <mat-icon matPrefix>search</mat-icon>
    <button mat-icon-button matSuffix
            *ngIf="searchTerm"
            (click)="clearSearch()"
            matTooltip="Clear search">
      <mat-icon>close</mat-icon>
    </button>
  </mat-form-field>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="isLoading">
  <mat-spinner diameter="48"></mat-spinner>
  <p class="loading-text">Loading mobile robots...</p>
</div>

<!-- Empty State -->
<div class="empty-state" *ngIf="!isLoading && filteredRobots.length === 0 && !searchTerm">
  <mat-icon class="empty-icon">smart_toy</mat-icon>
  <h3>No Mobile Robots Found</h3>
  <p>There are no mobile robots in the system. Click "Sync Robots" to fetch robots from the external system.</p>
  <button mat-raised-button
          color="primary"
          (click)="syncMobileRobots()"
          [disabled]="isSyncing">
    <mat-icon>sync</mat-icon>
    Sync Robots
  </button>
</div>

<!-- No Search Results -->
<div class="empty-state" *ngIf="!isLoading && filteredRobots.length === 0 && searchTerm">
  <mat-icon class="empty-icon">search_off</mat-icon>
  <h3>No Results Found</h3>
  <p>No mobile robots match your search "{{ searchTerm }}"</p>
  <button mat-stroked-button (click)="clearSearch()">
    <mat-icon>clear</mat-icon>
    Clear Search
  </button>
</div>

<!-- Robot Cards Grid -->
<div class="robot-cards-grid" *ngIf="!isLoading && filteredRobots.length > 0">
  <mat-card class="robot-card" *ngFor="let robot of filteredRobots">

    <!-- Card Header with Robot Icon and ID -->
    <div class="card-header" [class.unlicensed-card]="!robot.isLicensed">
      <div class="robot-icon-container">
        <img src="images/kmp-400p.png" alt="KUKA KMP 400P Robot" class="robot-image">
      </div>
      <div class="robot-header-info">
        <h3 class="robot-id" [matTooltip]="robot.robotId">{{ robot.robotId }}</h3>
        <span class="robot-type">{{ robot.robotTypeCode }}</span>
        <div class="status-row">
          <span class="status-badge"
                [ngClass]="getStatusClass(robot.status)"
                [matTooltip]="'Status: ' + robot.statusText">
            {{ robot.statusText }}
          </span>
          <span class="license-badge"
                [ngClass]="getLicenseStatusClass(robot.isLicensed)"
                [matTooltip]="robot.isLicensed ? 'Robot is licensed' : (robot.licenseError || 'Robot is not licensed')">
            <mat-icon>{{ robot.isLicensed ? 'verified' : 'gpp_bad' }}</mat-icon>
            {{ robot.isLicensed ? 'Licensed' : 'Unlicensed' }}
          </span>
        </div>
      </div>
    </div>

    <!-- License Warning Banner (for unlicensed robots) -->
    <div class="license-warning" *ngIf="!robot.isLicensed">
      <div class="warning-content">
        <mat-icon>warning</mat-icon>
        <span>{{ robot.licenseError || 'This robot requires a license to operate' }}</span>
      </div>
      <button mat-stroked-button
              color="primary"
              (click)="openLicenseDialog(robot); $event.stopPropagation()">
        <mat-icon>verified_user</mat-icon>
        Activate License
      </button>
    </div>

    <mat-divider></mat-divider>

    <!-- Card Content -->
    <mat-card-content class="card-content">

      <!-- Battery Level -->
      <div class="info-row">
        <div class="info-label">
          <mat-icon class="info-icon">battery_charging_full</mat-icon>
          Battery
        </div>
        <div class="info-value">
          <span class="battery-indicator"
                [ngClass]="getBatteryClass(robot.batteryLevel)"
                [matTooltip]="'Battery: ' + robot.batteryLevel + '%'">
            <mat-icon class="battery-icon" *ngIf="robot.batteryLevel >= 80">battery_full</mat-icon>
            <mat-icon class="battery-icon" *ngIf="robot.batteryLevel >= 50 && robot.batteryLevel < 80">battery_6_bar</mat-icon>
            <mat-icon class="battery-icon" *ngIf="robot.batteryLevel >= 20 && robot.batteryLevel < 50">battery_3_bar</mat-icon>
            <mat-icon class="battery-icon" *ngIf="robot.batteryLevel < 20">battery_1_bar</mat-icon>
            {{ robot.batteryLevel }}%
          </span>
        </div>
      </div>

      <mat-divider class="section-divider"></mat-divider>

      <!-- Location Information -->
      <div class="info-section-title">
        <mat-icon>location_on</mat-icon>
        Location
      </div>

      <!-- Map Code -->
      <div class="info-row">
        <div class="info-label">Map Code</div>
        <div class="info-value">
          <span class="map-code" [matTooltip]="robot.mapCode">{{ robot.mapCode }}</span>
        </div>
      </div>

      <!-- Floor -->
      <div class="info-row">
        <div class="info-label">Floor</div>
        <div class="info-value">
          <span class="floor-badge"
                [ngClass]="getFloorClass(robot.floorNumber)"
                [matTooltip]="'Floor: ' + robot.floorNumber">
            {{ robot.floorDisplay }}
          </span>
        </div>
      </div>

      <!-- Current Node -->
      <div class="info-row">
        <div class="info-label">Current Node</div>
        <div class="info-value">
          <span class="node-number" [matTooltip]="'Current node: ' + robot.lastNodeNumber">
            {{ robot.nodeDisplay }}
          </span>
        </div>
      </div>

      <mat-divider class="section-divider"></mat-divider>

      <!-- Position Information -->
      <div class="info-section-title">
        <mat-icon>my_location</mat-icon>
        Position
      </div>

      <!-- Coordinates -->
      <div class="info-row">
        <div class="info-label">Coordinates</div>
        <div class="info-value">
          <span class="coordinates"
                [matTooltip]="'Position: X=' + robot.xCoordinate + ', Y=' + robot.yCoordinate">
            {{ robot.coordinatesText }}
          </span>
        </div>
      </div>

      <!-- Orientation -->
      <div class="info-row">
        <div class="info-label">Orientation</div>
        <div class="info-value">
          <span class="orientation"
                [matTooltip]="'Robot orientation: ' + robot.robotOrientation + ' degrees'">
            <mat-icon class="orientation-icon">navigation</mat-icon>
            {{ robot.orientationText }}
          </span>
        </div>
      </div>

    </mat-card-content>

  </mat-card>
</div>
