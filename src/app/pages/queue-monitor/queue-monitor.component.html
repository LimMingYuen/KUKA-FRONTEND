<div class="queue-monitor-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <mat-icon class="header-icon">queue</mat-icon>
        <div>
          <h1>Queue Monitor</h1>
          <p class="subtitle">Monitor and manage mission queue in real-time</p>
        </div>
      </div>
      <div class="header-actions">
        <!-- Connection status indicator -->
        <span class="connection-status" [class.connected]="connectionState() === 'connected'" [class.fallback]="usingFallbackPolling()">
          <mat-icon>{{ connectionState() === 'connected' ? 'wifi' : 'wifi_off' }}</mat-icon>
          {{ connectionState() === 'connected' ? 'Real-time' : (connectionState() === 'connecting' ? 'Connecting...' : 'Polling') }}
        </span>
        <button mat-flat-button color="primary" (click)="refresh()">
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Statistics Dashboard -->
  <div class="statistics-section" *ngIf="statistics()">
    <h2 class="section-title">Dashboard</h2>
    <div class="stats-grid">
      <!-- Queued -->
      <mat-card class="stat-card queued">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>hourglass_empty</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalQueued || 0 }}</span>
            <span class="stat-label">Queued</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Processing -->
      <mat-card class="stat-card processing">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>sync</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalProcessing || 0 }}</span>
            <span class="stat-label">Processing</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Assigned -->
      <mat-card class="stat-card assigned">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>smart_toy</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalAssigned || 0 }}</span>
            <span class="stat-label">Assigned</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Completed -->
      <mat-card class="stat-card completed">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalCompleted || 0 }}</span>
            <span class="stat-label">Completed</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Failed -->
      <mat-card class="stat-card failed">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>error</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalFailed || 0 }}</span>
            <span class="stat-label">Failed</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Cancelled -->
      <mat-card class="stat-card cancelled">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>cancel</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalCancelled || 0 }}</span>
            <span class="stat-label">Cancelled</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Average Wait Time -->
      <mat-card class="stat-card wait-time">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>schedule</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ formatAverageWaitTime(statistics()?.averageWaitTimeSeconds || 0) }}</span>
            <span class="stat-label">Avg Wait Time</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Success Rate -->
      <mat-card class="stat-card success-rate">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ formatSuccessRate(statistics()?.successRate || 0) }}</span>
            <span class="stat-label">Success Rate</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="isLoading()">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading queue data...</p>
  </div>

  <!-- Active Queue Section -->
  <div class="queue-section" *ngIf="!isLoading()">
    <h2 class="section-title">
      <mat-icon>playlist_play</mat-icon>
      Active Queue
      <span class="badge" *ngIf="activeItemsCount() > 0">{{ activeItemsCount() }}</span>
    </h2>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="activeItemsCount() === 0">
      <mat-icon>inbox</mat-icon>
      <h3>Queue is Empty</h3>
      <p>No missions are currently in the queue.</p>
    </div>

    <!-- Queue Table -->
    <mat-card class="queue-table-card" *ngIf="activeItemsCount() > 0">
      <table mat-table [dataSource]="activeItemsDataSource" class="queue-table">
        <!-- Position Column -->
        <ng-container matColumnDef="queuePosition">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let item">
            <span class="position-badge">{{ item.statusCode === 0 ? item.queuePosition : '-' }}</span>
          </td>
        </ng-container>

        <!-- Mission Name Column -->
        <ng-container matColumnDef="missionName">
          <th mat-header-cell *matHeaderCellDef>Mission</th>
          <td mat-cell *matCellDef="let item">
            <div class="mission-info">
              <span class="mission-name">{{ item.missionName || item.missionCode }}</span>
              <span class="mission-code">{{ item.missionCode }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let item">
            <span class="status-chip" [ngClass]="item.statusClass">
              <mat-icon>{{ getStatusIcon(item.statusCode) }}</mat-icon>
              {{ item.statusText }}
            </span>
          </td>
        </ng-container>

        <!-- Priority Column -->
        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef>Priority</th>
          <td mat-cell *matCellDef="let item">
            <mat-form-field appearance="outline" class="priority-select">
              <mat-select [value]="item.priority"
                          (selectionChange)="changePriority(item, $event.value)"
                          [disabled]="isProcessing(item.id) || item.statusCode !== 0">
                <mat-option *ngFor="let opt of priorityOptions" [value]="opt.value">
                  {{ opt.text }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>

        <!-- Robot Column -->
        <ng-container matColumnDef="robotDisplay">
          <th mat-header-cell *matHeaderCellDef>Robot</th>
          <td mat-cell *matCellDef="let item">
            <span [class.unassigned]="!item.assignedRobotId">{{ item.robotDisplay }}</span>
          </td>
        </ng-container>

        <!-- Wait Time Column -->
        <ng-container matColumnDef="waitTimeDisplay">
          <th mat-header-cell *matHeaderCellDef>Wait Time</th>
          <td mat-cell *matCellDef="let item">{{ item.waitTimeDisplay }}</td>
        </ng-container>

        <!-- Created Column -->
        <ng-container matColumnDef="createdDateRelative">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let item">
            {{ item.createdDateDisplay }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let item">
            <div class="action-buttons">
              <!-- Cancel -->
              <button mat-icon-button
                      color="warn"
                      matTooltip="Cancel"
                      [disabled]="!item.canCancel || isProcessing(item.id)"
                      (click)="cancelItem(item)">
                <mat-icon>cancel</mat-icon>
              </button>

              <!-- Loading indicator -->
              <mat-spinner *ngIf="isProcessing(item.id)" diameter="20"></mat-spinner>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" [attr.data-id]="row.id"></tr>
      </table>
    </mat-card>
  </div>

</div>
