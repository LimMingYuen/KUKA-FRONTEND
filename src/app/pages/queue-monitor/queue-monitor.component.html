<div class="queue-monitor-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <mat-icon class="header-icon">queue</mat-icon>
        <div>
          <h1>Queue Monitor</h1>
          <p class="subtitle">Monitor and manage mission queue in real-time</p>
        </div>
      </div>
      <div class="header-actions">
        <button mat-stroked-button
                [class.active]="autoRefresh()"
                (click)="toggleAutoRefresh()"
                matTooltip="Toggle auto-refresh (every 5 seconds)">
          <mat-icon>{{ autoRefresh() ? 'sync' : 'sync_disabled' }}</mat-icon>
          Auto-refresh {{ autoRefresh() ? 'ON' : 'OFF' }}
        </button>
        <button mat-flat-button color="primary" (click)="refresh()">
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Statistics Dashboard -->
  <div class="statistics-section" *ngIf="statistics()">
    <h2 class="section-title">Dashboard</h2>
    <div class="stats-grid">
      <!-- Queued -->
      <mat-card class="stat-card queued">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>hourglass_empty</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalQueued || 0 }}</span>
            <span class="stat-label">Queued</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Processing -->
      <mat-card class="stat-card processing">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>sync</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalProcessing || 0 }}</span>
            <span class="stat-label">Processing</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Assigned -->
      <mat-card class="stat-card assigned">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>smart_toy</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalAssigned || 0 }}</span>
            <span class="stat-label">Assigned</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Completed -->
      <mat-card class="stat-card completed">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalCompleted || 0 }}</span>
            <span class="stat-label">Completed</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Failed -->
      <mat-card class="stat-card failed">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>error</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalFailed || 0 }}</span>
            <span class="stat-label">Failed</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Cancelled -->
      <mat-card class="stat-card cancelled">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>cancel</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ statistics()?.totalCancelled || 0 }}</span>
            <span class="stat-label">Cancelled</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Average Wait Time -->
      <mat-card class="stat-card wait-time">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>schedule</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ formatAverageWaitTime(statistics()?.averageWaitTimeSeconds || 0) }}</span>
            <span class="stat-label">Avg Wait Time</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Success Rate -->
      <mat-card class="stat-card success-rate">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ formatSuccessRate(statistics()?.successRate || 0) }}</span>
            <span class="stat-label">Success Rate</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="isLoading()">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading queue data...</p>
  </div>

  <!-- Active Queue Section -->
  <div class="queue-section" *ngIf="!isLoading()">
    <h2 class="section-title">
      <mat-icon>playlist_play</mat-icon>
      Active Queue
      <span class="badge" *ngIf="getActiveItems().length > 0">{{ getActiveItems().length }}</span>
    </h2>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="getActiveItems().length === 0">
      <mat-icon>inbox</mat-icon>
      <h3>Queue is Empty</h3>
      <p>No missions are currently in the queue.</p>
    </div>

    <!-- Queue Table -->
    <mat-card class="queue-table-card" *ngIf="getActiveItems().length > 0">
      <table mat-table [dataSource]="getActiveItems()" class="queue-table">
        <!-- Position Column -->
        <ng-container matColumnDef="queuePosition">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let item">
            <span class="position-badge">{{ item.queuePosition || '-' }}</span>
          </td>
        </ng-container>

        <!-- Mission Name Column -->
        <ng-container matColumnDef="missionName">
          <th mat-header-cell *matHeaderCellDef>Mission</th>
          <td mat-cell *matCellDef="let item">
            <div class="mission-info">
              <span class="mission-name">{{ item.missionName || item.missionCode }}</span>
              <span class="mission-code">{{ item.missionCode }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let item">
            <span class="status-chip" [ngClass]="item.statusClass">
              <mat-icon>{{ getStatusIcon(item.statusCode) }}</mat-icon>
              {{ item.statusText }}
            </span>
          </td>
        </ng-container>

        <!-- Priority Column -->
        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef>Priority</th>
          <td mat-cell *matCellDef="let item">
            <mat-form-field appearance="outline" class="priority-select">
              <mat-select [value]="item.priority"
                          (selectionChange)="changePriority(item, $event.value)"
                          [disabled]="isProcessing(item.id) || item.statusCode !== 0">
                <mat-option *ngFor="let opt of priorityOptions" [value]="opt.value">
                  {{ opt.text }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>

        <!-- Robot Column -->
        <ng-container matColumnDef="robotDisplay">
          <th mat-header-cell *matHeaderCellDef>Robot</th>
          <td mat-cell *matCellDef="let item">
            <span [class.unassigned]="!item.assignedRobotId">{{ item.robotDisplay }}</span>
          </td>
        </ng-container>

        <!-- Wait Time Column -->
        <ng-container matColumnDef="waitTimeDisplay">
          <th mat-header-cell *matHeaderCellDef>Wait Time</th>
          <td mat-cell *matCellDef="let item">{{ item.waitTimeDisplay }}</td>
        </ng-container>

        <!-- Created Column -->
        <ng-container matColumnDef="createdDateRelative">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let item" [matTooltip]="item.createdDateDisplay">
            {{ item.createdDateRelative }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let item">
            <div class="action-buttons">
              <!-- Move Up -->
              <button mat-icon-button
                      color="primary"
                      matTooltip="Move Up"
                      [disabled]="!item.canMoveUp || isProcessing(item.id)"
                      (click)="moveUp(item)">
                <mat-icon>arrow_upward</mat-icon>
              </button>

              <!-- Move Down -->
              <button mat-icon-button
                      color="primary"
                      matTooltip="Move Down"
                      [disabled]="!item.canMoveDown || isProcessing(item.id)"
                      (click)="moveDown(item)">
                <mat-icon>arrow_downward</mat-icon>
              </button>

              <!-- Cancel -->
              <button mat-icon-button
                      color="warn"
                      matTooltip="Cancel"
                      [disabled]="!item.canCancel || isProcessing(item.id)"
                      (click)="cancelItem(item)">
                <mat-icon>cancel</mat-icon>
              </button>

              <!-- Loading indicator -->
              <mat-spinner *ngIf="isProcessing(item.id)" diameter="20"></mat-spinner>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </mat-card>
  </div>

  <!-- History Section -->
  <div class="history-section" *ngIf="!isLoading() && getHistoryItems().length > 0">
    <h2 class="section-title">
      <mat-icon>history</mat-icon>
      Recent History
      <span class="badge secondary">{{ getHistoryItems().length }}</span>
    </h2>

    <mat-card class="history-table-card">
      <table mat-table [dataSource]="getHistoryItems()" class="history-table">
        <!-- Mission Name Column -->
        <ng-container matColumnDef="missionName">
          <th mat-header-cell *matHeaderCellDef>Mission</th>
          <td mat-cell *matCellDef="let item">
            <div class="mission-info">
              <span class="mission-name">{{ item.missionName || item.missionCode }}</span>
              <span class="mission-code">{{ item.missionCode }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let item">
            <span class="status-chip" [ngClass]="item.statusClass">
              <mat-icon>{{ getStatusIcon(item.statusCode) }}</mat-icon>
              {{ item.statusText }}
            </span>
          </td>
        </ng-container>

        <!-- Robot Column -->
        <ng-container matColumnDef="robotDisplay">
          <th mat-header-cell *matHeaderCellDef>Robot</th>
          <td mat-cell *matCellDef="let item">{{ item.robotDisplay }}</td>
        </ng-container>

        <!-- Wait Time Column -->
        <ng-container matColumnDef="waitTimeDisplay">
          <th mat-header-cell *matHeaderCellDef>Duration</th>
          <td mat-cell *matCellDef="let item">{{ item.waitTimeDisplay }}</td>
        </ng-container>

        <!-- Created Column -->
        <ng-container matColumnDef="createdDateRelative">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let item" [matTooltip]="item.createdDateDisplay">
            {{ item.createdDateRelative }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let item">
            <div class="action-buttons">
              <!-- Retry (for failed items) -->
              <button mat-icon-button
                      color="primary"
                      matTooltip="Retry"
                      *ngIf="item.canRetry"
                      [disabled]="isProcessing(item.id)"
                      (click)="retryItem(item)">
                <mat-icon>replay</mat-icon>
              </button>

              <!-- Error message tooltip for failed items -->
              <mat-icon *ngIf="item.errorMessage"
                        class="error-icon"
                        [matTooltip]="item.errorMessage">
                info
              </mat-icon>

              <!-- Loading indicator -->
              <mat-spinner *ngIf="isProcessing(item.id)" diameter="20"></mat-spinner>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['missionName', 'status', 'robotDisplay', 'waitTimeDisplay', 'createdDateRelative', 'actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['missionName', 'status', 'robotDisplay', 'waitTimeDisplay', 'createdDateRelative', 'actions'];"></tr>
      </table>
    </mat-card>
  </div>
</div>
