<div class="mission-control-container">
  <!-- Header -->
  <div class="page-header">
    <h1>
      <mat-icon>settings_remote</mat-icon>
      Mission Control Center
    </h1>
    <p class="subtitle">Trigger workflows and custom missions with one click</p>
    <button mat-icon-button (click)="refresh()" matTooltip="Refresh All">
      <mat-icon>refresh</mat-icon>
    </button>
  </div>

  <!-- Main Content with Tabs -->
  <mat-tab-group animationDuration="300ms" class="mission-tabs">

    <!-- Tab 1: Sync Workflows -->
    <mat-tab label="Sync Workflows">
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">sync</mat-icon>
        Sync Workflows
        <span class="badge" *ngIf="workflows.length > 0">{{ workflows.length }}</span>
      </ng-template>

      <div class="tab-content">
        <!-- Filter Actions -->
        <div class="filter-actions" *ngIf="!isLoadingWorkflows && workflows.length > 0">
          <button mat-stroked-button (click)="openSelectWorkflowsDialog()" class="filter-btn">
            <mat-icon>filter_list</mat-icon>
            <span>Select Workflows</span>
            <span class="filter-badge" *ngIf="selectedWorkflowIds.size > 0">{{ selectedWorkflowIds.size }}</span>
          </button>
          <button mat-icon-button *ngIf="selectedWorkflowIds.size > 0" (click)="clearWorkflowFilter()" matTooltip="Clear filter">
            <mat-icon>clear</mat-icon>
          </button>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoadingWorkflows" class="loading-state">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Loading workflows...</p>
        </div>

        <!-- Workflows Grouped by Zone -->
        <div *ngIf="!isLoadingWorkflows && workflows.length > 0" class="zone-sections">
          <mat-accordion multi>
            <mat-expansion-panel
              *ngFor="let zone of filteredWorkflowsByZone | keyvalue"
              [expanded]="isZoneExpanded(zone.key)"
              (opened)="expandedZones.add(zone.key)"
              (closed)="expandedZones.delete(zone.key)"
              class="zone-panel">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>location_on</mat-icon>
                  {{ zone.key }}
                </mat-panel-title>
                <mat-panel-description>
                  {{ zone.value.length }} workflow{{ zone.value.length !== 1 ? 's' : '' }}
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="missions-grid">
                <mat-card *ngFor="let workflow of zone.value" class="mission-card">
                  <mat-card-header>
                    <div mat-card-avatar class="workflow-icon" [matBadge]="hasActiveJob(workflow.id, 'workflow') ? '!' : ''"
                         [matBadgeHidden]="!hasActiveJob(workflow.id, 'workflow')" matBadgeColor="accent">
                      <mat-icon>account_tree</mat-icon>
                    </div>
                    <mat-card-title>
                      <span class="title-text">{{ workflow.name }}</span>
                      <mat-chip [class]="'status-chip-' + workflow.status">
                        <mat-icon matChipAvatar>{{ workflow.status === 1 ? 'check_circle' : 'cancel' }}</mat-icon>
                        {{ workflow.statusText }}
                      </mat-chip>
                    </mat-card-title>
                  </mat-card-header>

                  <mat-card-content>
                    <!-- Job Status Expansion Panel (shown when workflow is triggered) -->
                    <mat-expansion-panel *ngIf="workflowJobs.get(workflow.id) as job" class="job-status-panel" [expanded]="true">
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon>work</mat-icon>
                          <span>Active Job Status</span>
                        </mat-panel-title>
                        <mat-panel-description *ngIf="job.jobData">
                          <mat-chip [color]="MissionsUtils.getJobStatusColor(job.jobData.status)" selected>
                            {{ MissionsUtils.getJobStatusText(job.jobData.status) }}
                          </mat-chip>
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      <!-- Job Details List -->
                      <mat-list class="job-details-list">
                        <mat-list-item *ngIf="job.jobData?.robotId">
                          <mat-icon matListItemIcon color="primary">smart_toy</mat-icon>
                          <div matListItemTitle>Robot ID</div>
                          <div matListItemLine class="highlight-value">{{ job.jobData?.robotId }}</div>
                        </mat-list-item>

                        <mat-list-item *ngIf="job.robotData?.currentLocation">
                          <mat-icon matListItemIcon color="primary">location_on</mat-icon>
                          <div matListItemTitle>Current Location</div>
                          <div matListItemLine class="highlight-value">{{ job.robotData?.currentLocation }}</div>
                        </mat-list-item>

                        <mat-list-item *ngIf="job.robotData?.nodeCode">
                          <mat-icon matListItemIcon color="primary">pin_drop</mat-icon>
                          <div matListItemTitle>Current Node Code</div>
                          <div matListItemLine class="highlight-value">{{ job.robotData?.nodeCode }}</div>
                        </mat-list-item>

                        <mat-list-item *ngIf="job.jobData?.mapCode">
                          <mat-icon matListItemIcon>map</mat-icon>
                          <div matListItemTitle>Map Code</div>
                          <div matListItemLine>{{ job.jobData?.mapCode }}</div>
                        </mat-list-item>

                        <mat-list-item *ngIf="job.jobData?.targetCellCode">
                          <mat-icon matListItemIcon>flag</mat-icon>
                          <div matListItemTitle>Target Node</div>
                          <div matListItemLine>{{ job.jobData?.targetCellCode }}</div>
                        </mat-list-item>

                        <mat-list-item *ngIf="job.robotData?.batteryLevel !== undefined">
                          <mat-icon matListItemIcon [color]="(job.robotData?.batteryLevel ?? 0) > 20 ? 'primary' : 'warn'">battery_charging_full</mat-icon>
                          <div matListItemTitle>Battery Level</div>
                          <div matListItemLine>
                            <div class="battery-info">
                              <span class="battery-text">{{ job.robotData?.batteryLevel }}%</span>
                              <mat-progress-bar mode="determinate" [value]="job.robotData?.batteryLevel ?? 0"
                                               [color]="(job.robotData?.batteryLevel ?? 0) > 20 ? 'primary' : 'warn'">
                              </mat-progress-bar>
                            </div>
                          </div>
                        </mat-list-item>

                        <mat-list-item *ngIf="!job.jobData">
                          <mat-icon matListItemIcon>hourglass_empty</mat-icon>
                          <div matListItemTitle>Mission Code</div>
                          <div matListItemLine>
                            {{ job.missionCode }}
                            <mat-chip color="accent">Querying...</mat-chip>
                          </div>
                        </mat-list-item>
                      </mat-list>
                    </mat-expansion-panel>
                  </mat-card-content>

                  <mat-card-actions class="card-actions">
                    <button
                      mat-raised-button
                      color="primary"
                      (click)="triggerWorkflow(workflow)"
                      [disabled]="isTriggering(workflow.id) || hasActiveJob(workflow.id, 'workflow')"
                      class="action-btn trigger-btn">
                      <mat-spinner *ngIf="isTriggering(workflow.id)" diameter="20"></mat-spinner>
                      <mat-icon *ngIf="!isTriggering(workflow.id)">play_arrow</mat-icon>
                      <span *ngIf="!isTriggering(workflow.id)">Trigger</span>
                      <span *ngIf="isTriggering(workflow.id)">Triggering...</span>
                    </button>
                    <button
                      mat-raised-button
                      color="warn"
                      (click)="cancelMission(workflow.id, 'workflow', $event)"
                      [disabled]="!hasActiveJob(workflow.id, 'workflow') || isCancelling(workflow.id)"
                      class="action-btn cancel-btn">
                      <mat-spinner *ngIf="isCancelling(workflow.id)" diameter="20"></mat-spinner>
                      <mat-icon *ngIf="!isCancelling(workflow.id)">cancel</mat-icon>
                      <span *ngIf="!isCancelling(workflow.id)">Cancel</span>
                      <span *ngIf="isCancelling(workflow.id)">Cancelling...</span>
                    </button>
                  </mat-card-actions>
                </mat-card>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoadingWorkflows && workflows.length === 0" class="empty-state">
          <mat-icon>account_tree</mat-icon>
          <h3>No Workflows Available</h3>
          <p>No sync workflows found. Please sync workflows from the Workflows Management page.</p>
          <button mat-raised-button color="accent" routerLink="/workflows">
            <mat-icon>sync</mat-icon>
            Go to Workflows Management
          </button>
        </div>
      </div>
    </mat-tab>

    <!-- Tab 2: Custom Missions -->
    <mat-tab label="Custom Missions">
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">build</mat-icon>
        Custom Missions
        <span class="badge" *ngIf="customMissions.length > 0">{{ customMissions.length }}</span>
      </ng-template>

      <div class="tab-content">
        <!-- Filter Actions -->
        <div class="filter-actions" *ngIf="!isLoadingCustomMissions && customMissions.length > 0">
          <button mat-stroked-button (click)="openSelectCustomMissionsDialog()" class="filter-btn">
            <mat-icon>filter_list</mat-icon>
            <span>Select Missions</span>
            <span class="filter-badge" *ngIf="selectedCustomMissionIds.size > 0">{{ selectedCustomMissionIds.size }}</span>
          </button>
          <button mat-icon-button *ngIf="selectedCustomMissionIds.size > 0" (click)="clearCustomMissionFilter()" matTooltip="Clear filter">
            <mat-icon>clear</mat-icon>
          </button>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoadingCustomMissions" class="loading-state">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Loading custom missions...</p>
        </div>

        <!-- Custom Missions Grouped by Zone -->
        <div *ngIf="!isLoadingCustomMissions && customMissions.length > 0" class="zone-sections">
          <mat-accordion multi>
            <mat-expansion-panel
              *ngFor="let zone of filteredCustomMissionsByZone | keyvalue"
              [expanded]="isCustomZoneExpanded(zone.key)"
              (opened)="expandedCustomZones.add(zone.key)"
              (closed)="expandedCustomZones.delete(zone.key)"
              class="zone-panel">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>location_on</mat-icon>
                  {{ zone.key }}
                </mat-panel-title>
                <mat-panel-description>
                  {{ zone.value.length }} mission{{ zone.value.length !== 1 ? 's' : '' }}
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="missions-grid">
                <mat-card *ngFor="let mission of zone.value" class="mission-card">
                  <mat-card-header>
                    <div mat-card-avatar class="custom-mission-icon" [matBadge]="hasActiveJob(mission.id, 'custom') ? '!' : ''"
                         [matBadgeHidden]="!hasActiveJob(mission.id, 'custom')" matBadgeColor="accent">
                      <mat-icon>build_circle</mat-icon>
                    </div>
                    <mat-card-title>
                      <span class="title-text">{{ mission.missionName }}</span>
                    </mat-card-title>
                  </mat-card-header>

                  <mat-card-content>
                    <!-- Job Status Expansion Panel (shown when custom mission is triggered) -->
                    <mat-expansion-panel *ngIf="customMissionJobs.get(mission.id) as job" class="job-status-panel" [expanded]="true">
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon>work</mat-icon>
                          <span>Active Job Status</span>
                        </mat-panel-title>
                        <mat-panel-description *ngIf="job.jobData">
                          <mat-chip [color]="MissionsUtils.getJobStatusColor(job.jobData.status)" selected>
                            {{ MissionsUtils.getJobStatusText(job.jobData.status) }}
                          </mat-chip>
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      <!-- Job Details List -->
                      <mat-list class="job-details-list">
                        <mat-list-item *ngIf="job.jobData?.robotId">
                          <mat-icon matListItemIcon color="primary">smart_toy</mat-icon>
                          <div matListItemTitle>Robot ID</div>
                          <div matListItemLine class="highlight-value">{{ job.jobData?.robotId }}</div>
                        </mat-list-item>

                        <mat-list-item *ngIf="job.robotData?.currentLocation">
                          <mat-icon matListItemIcon color="primary">location_on</mat-icon>
                          <div matListItemTitle>Current Location</div>
                          <div matListItemLine class="highlight-value">{{ job.robotData?.currentLocation }}</div>
                        </mat-list-item>

                        <mat-list-item *ngIf="job.robotData?.nodeCode">
                          <mat-icon matListItemIcon color="primary">pin_drop</mat-icon>
                          <div matListItemTitle>Current Node Code</div>
                          <div matListItemLine class="highlight-value">{{ job.robotData?.nodeCode }}</div>
                        </mat-list-item>

                        <mat-list-item *ngIf="job.jobData?.mapCode">
                          <mat-icon matListItemIcon>map</mat-icon>
                          <div matListItemTitle>Map Code</div>
                          <div matListItemLine>{{ job.jobData?.mapCode }}</div>
                        </mat-list-item>

                        <mat-list-item *ngIf="job.jobData?.targetCellCode">
                          <mat-icon matListItemIcon>flag</mat-icon>
                          <div matListItemTitle>Target Node</div>
                          <div matListItemLine>{{ job.jobData?.targetCellCode }}</div>
                        </mat-list-item>

                        <mat-list-item *ngIf="job.robotData?.batteryLevel !== undefined">
                          <mat-icon matListItemIcon [color]="(job.robotData?.batteryLevel ?? 0) > 20 ? 'primary' : 'warn'">battery_charging_full</mat-icon>
                          <div matListItemTitle>Battery Level</div>
                          <div matListItemLine>
                            <div class="battery-info">
                              <span class="battery-text">{{ job.robotData?.batteryLevel }}%</span>
                              <mat-progress-bar mode="determinate" [value]="job.robotData?.batteryLevel ?? 0"
                                               [color]="(job.robotData?.batteryLevel ?? 0) > 20 ? 'primary' : 'warn'">
                              </mat-progress-bar>
                            </div>
                          </div>
                        </mat-list-item>

                        <mat-list-item *ngIf="!job.jobData">
                          <mat-icon matListItemIcon>hourglass_empty</mat-icon>
                          <div matListItemTitle>Mission Code</div>
                          <div matListItemLine>
                            {{ job.missionCode }}
                            <mat-chip color="accent">Querying...</mat-chip>
                          </div>
                        </mat-list-item>
                      </mat-list>
                    </mat-expansion-panel>
                  </mat-card-content>

                  <mat-card-actions class="card-actions">
                    <button
                      mat-raised-button
                      color="primary"
                      (click)="triggerCustomMission(mission)"
                      [disabled]="isTriggering(mission.id) || hasActiveJob(mission.id, 'custom')"
                      class="action-btn trigger-btn">
                      <mat-spinner *ngIf="isTriggering(mission.id)" diameter="20"></mat-spinner>
                      <mat-icon *ngIf="!isTriggering(mission.id)">play_arrow</mat-icon>
                      <span *ngIf="!isTriggering(mission.id)">Trigger</span>
                      <span *ngIf="isTriggering(mission.id)">Triggering...</span>
                    </button>
                    <button
                      mat-raised-button
                      color="warn"
                      (click)="cancelMission(mission.id, 'custom', $event)"
                      [disabled]="!hasActiveJob(mission.id, 'custom') || isCancelling(mission.id)"
                      class="action-btn cancel-btn">
                      <mat-spinner *ngIf="isCancelling(mission.id)" diameter="20"></mat-spinner>
                      <mat-icon *ngIf="!isCancelling(mission.id)">cancel</mat-icon>
                      <span *ngIf="!isCancelling(mission.id)">Cancel</span>
                      <span *ngIf="isCancelling(mission.id)">Cancelling...</span>
                    </button>
                  </mat-card-actions>
                </mat-card>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoadingCustomMissions && customMissions.length === 0" class="empty-state">
          <mat-icon>build_circle</mat-icon>
          <h3>No Custom Missions Available</h3>
          <p>No custom missions found. Please create custom missions from the Saved Custom Missions page.</p>
          <button mat-raised-button color="accent" routerLink="/saved-custom-missions">
            <mat-icon>add_circle</mat-icon>
            Create Custom Mission
          </button>
        </div>
      </div>
    </mat-tab>

  </mat-tab-group>
</div>
