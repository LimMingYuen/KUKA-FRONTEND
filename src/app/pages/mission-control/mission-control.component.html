<div class="mission-control-container">
  <!-- Header -->
  <div class="page-header">
    <h1>
      <mat-icon>settings_remote</mat-icon>
      Mission Control Center
    </h1>
    <p class="subtitle">Trigger workflows and custom missions with one click</p>
    <button mat-icon-button (click)="refresh()" matTooltip="Refresh All">
      <mat-icon>refresh</mat-icon>
    </button>
  </div>

  <!-- Main Content with Tabs -->
  <mat-tab-group animationDuration="300ms" class="mission-tabs">

    <!-- Tab 1: Sync Workflows -->
    <mat-tab label="Sync Workflows">
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">sync</mat-icon>
        Sync Workflows
        <span class="badge" *ngIf="workflows.length > 0">{{ workflows.length }}</span>
      </ng-template>

      <div class="tab-content">
        <!-- Loading State -->
        <div *ngIf="isLoadingWorkflows" class="loading-state">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Loading workflows...</p>
        </div>

        <!-- Workflows Grid -->
        <div *ngIf="!isLoadingWorkflows && workflows.length > 0" class="missions-grid">
          <mat-card *ngFor="let workflow of workflows" class="mission-card">
            <mat-card-header>
              <div mat-card-avatar class="workflow-icon">
                <mat-icon>account_tree</mat-icon>
              </div>
              <mat-card-title>{{ workflow.name }}</mat-card-title>
              <mat-card-subtitle>{{ workflow.code }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="mission-info">
                <div class="info-row">
                  <span class="label">ID:</span>
                  <span class="value">{{ workflow.id }}</span>
                </div>
                <div class="info-row">
                  <span class="label">External Code:</span>
                  <span class="value">{{ workflow.externalCode }}</span>
                </div>
                <div class="info-row">
                  <span class="label">Layout:</span>
                  <span class="value">{{ workflow.layoutCode }}</span>
                </div>
                <div class="info-row">
                  <span class="label">Status:</span>
                  <mat-chip [class]="'status-chip-' + workflow.status">
                    {{ workflow.statusText }}
                  </mat-chip>
                </div>
              </div>
            </mat-card-content>
            <mat-card-actions>
              <button
                mat-raised-button
                color="primary"
                (click)="triggerWorkflow(workflow)"
                [disabled]="isTriggering(workflow.id)"
                class="trigger-btn">
                <mat-spinner *ngIf="isTriggering(workflow.id)" diameter="20"></mat-spinner>
                <mat-icon *ngIf="!isTriggering(workflow.id)">play_arrow</mat-icon>
                <span *ngIf="!isTriggering(workflow.id)">Trigger</span>
                <span *ngIf="isTriggering(workflow.id)">Triggering...</span>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoadingWorkflows && workflows.length === 0" class="empty-state">
          <mat-icon>account_tree</mat-icon>
          <h3>No Workflows Available</h3>
          <p>No sync workflows found. Please sync workflows from the Workflows Management page.</p>
          <button mat-raised-button color="accent" routerLink="/workflows">
            <mat-icon>sync</mat-icon>
            Go to Workflows Management
          </button>
        </div>
      </div>
    </mat-tab>

    <!-- Tab 2: Custom Missions -->
    <mat-tab label="Custom Missions">
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">build</mat-icon>
        Custom Missions
        <span class="badge" *ngIf="customMissions.length > 0">{{ customMissions.length }}</span>
      </ng-template>

      <div class="tab-content">
        <!-- Loading State -->
        <div *ngIf="isLoadingCustomMissions" class="loading-state">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Loading custom missions...</p>
        </div>

        <!-- Custom Missions Grid -->
        <div *ngIf="!isLoadingCustomMissions && customMissions.length > 0" class="missions-grid">
          <mat-card *ngFor="let mission of customMissions" class="mission-card">
            <mat-card-header>
              <div mat-card-avatar class="custom-mission-icon">
                <mat-icon>build_circle</mat-icon>
              </div>
              <mat-card-title>{{ mission.missionName }}</mat-card-title>
              <mat-card-subtitle>ID: {{ mission.id }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="mission-info">
                <div class="info-row" *ngIf="mission.description">
                  <span class="label">Description:</span>
                  <span class="value">{{ mission.description }}</span>
                </div>
                <div class="info-row" *ngIf="mission.missionType">
                  <span class="label">Type:</span>
                  <span class="value">{{ mission.missionType }}</span>
                </div>
                <div class="info-row" *ngIf="mission.priority">
                  <span class="label">Priority:</span>
                  <mat-chip class="priority-chip">{{ mission.priority }}</mat-chip>
                </div>
                <div class="info-row" *ngIf="mission.robotType">
                  <span class="label">Robot Type:</span>
                  <span class="value">{{ mission.robotType }}</span>
                </div>
                <div class="info-row" *ngIf="mission.robotIds && mission.robotIds !== '-'">
                  <span class="label">Robot IDs:</span>
                  <span class="value">{{ mission.robotIds }}</span>
                </div>
              </div>
            </mat-card-content>
            <mat-card-actions>
              <button
                mat-raised-button
                color="primary"
                (click)="triggerCustomMission(mission)"
                [disabled]="isTriggering(mission.id)"
                class="trigger-btn">
                <mat-spinner *ngIf="isTriggering(mission.id)" diameter="20"></mat-spinner>
                <mat-icon *ngIf="!isTriggering(mission.id)">play_arrow</mat-icon>
                <span *ngIf="!isTriggering(mission.id)">Trigger</span>
                <span *ngIf="isTriggering(mission.id)">Triggering...</span>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoadingCustomMissions && customMissions.length === 0" class="empty-state">
          <mat-icon>build_circle</mat-icon>
          <h3>No Custom Missions Available</h3>
          <p>No custom missions found. Please create custom missions from the Saved Custom Missions page.</p>
          <button mat-raised-button color="accent" routerLink="/saved-custom-missions">
            <mat-icon>add_circle</mat-icon>
            Create Custom Mission
          </button>
        </div>
      </div>
    </mat-tab>

    <!-- Tab 3: Active Jobs -->
    <mat-tab label="Active Jobs">
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">pending_actions</mat-icon>
        Active Jobs
        <span class="badge" *ngIf="activeJobs.size > 0">{{ activeJobs.size }}</span>
      </ng-template>

      <div class="tab-content">
        <!-- Active Jobs List -->
        <div *ngIf="activeJobs.size > 0" class="jobs-list">
          <mat-card *ngFor="let job of getActiveJobsArray()" class="job-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>work</mat-icon>
                {{ job.jobData.jobCode || job.missionCode }}
              </mat-card-title>
              <button mat-icon-button (click)="clearJob(job.missionCode)" matTooltip="Clear">
                <mat-icon>close</mat-icon>
              </button>
            </mat-card-header>
            <mat-card-content>
              <div class="job-details">
                <!-- Status Section -->
                <div class="detail-section">
                  <h4>Job Status</h4>
                  <div class="detail-row">
                    <span class="label">Status:</span>
                    <mat-chip [color]="MissionsUtils.getJobStatusColor(job.jobData.status)" selected>
                      {{ MissionsUtils.getJobStatusText(job.jobData.status) }}
                    </mat-chip>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.workflowName">
                    <span class="label">Workflow:</span>
                    <span class="value">{{ job.jobData.workflowName }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.workflowCode">
                    <span class="label">Workflow Code:</span>
                    <span class="value">{{ job.jobData.workflowCode }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.workflowPriority">
                    <span class="label">Priority:</span>
                    <span class="value">{{ job.jobData.workflowPriority }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.source">
                    <span class="label">Source:</span>
                    <span class="value">{{ job.jobData.source }}</span>
                  </div>
                </div>

                <mat-divider></mat-divider>

                <!-- Robot & Location Section -->
                <div class="detail-section">
                  <h4>Robot & Location</h4>
                  <div class="detail-row" *ngIf="job.jobData.robotId">
                    <span class="label">Robot ID:</span>
                    <span class="value">{{ job.jobData.robotId }}</span>
                  </div>
                  <div class="detail-row" *ngIf="getRobotForJob(job.jobData) as robot">
                    <span class="label">Robot Current Node:</span>
                    <span class="value highlight">{{ robot.currentLocation || '-' }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.mapCode">
                    <span class="label">Map Code:</span>
                    <span class="value">{{ job.jobData.mapCode }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.containerCode">
                    <span class="label">Container:</span>
                    <span class="value">{{ job.jobData.containerCode }}</span>
                  </div>
                </div>

                <mat-divider></mat-divider>

                <!-- Task Progress Section -->
                <div class="detail-section">
                  <h4>Task Progress</h4>
                  <div class="detail-row" *ngIf="job.jobData.beginCellCode">
                    <span class="label">Begin Node:</span>
                    <span class="value">{{ job.jobData.beginCellCode }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.targetCellCode">
                    <span class="label">Target Node:</span>
                    <span class="value">{{ job.jobData.targetCellCode }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.finalNodeCode">
                    <span class="label">Final Node:</span>
                    <span class="value">{{ job.jobData.finalNodeCode }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.targetCellCodeForeign">
                    <span class="label">Target Foreign Code:</span>
                    <span class="value">{{ job.jobData.targetCellCodeForeign }}</span>
                  </div>
                </div>

                <mat-divider></mat-divider>

                <!-- Timing Section -->
                <div class="detail-section">
                  <h4>Timing</h4>
                  <div class="detail-row" *ngIf="job.jobData.createTime">
                    <span class="label">Created:</span>
                    <span class="value">{{ job.jobData.createTime }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.completeTime">
                    <span class="label">Completed:</span>
                    <span class="value">{{ job.jobData.completeTime }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.spendTime">
                    <span class="label">Duration:</span>
                    <span class="value">{{ MissionsUtils.formatSpendTime(job.jobData.spendTime) }}</span>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.createUsername">
                    <span class="label">Created By:</span>
                    <span class="value">{{ job.jobData.createUsername }}</span>
                  </div>
                </div>

                <!-- Warnings Section -->
                <div class="detail-section" *ngIf="job.jobData.warnFlag === 1">
                  <h4>Warnings</h4>
                  <div class="detail-row">
                    <span class="label">Warning Status:</span>
                    <mat-chip color="warn" selected>Active Warning</mat-chip>
                  </div>
                  <div class="detail-row" *ngIf="job.jobData.warnCode">
                    <span class="label">Warning Code:</span>
                    <span class="value">{{ job.jobData.warnCode }}</span>
                  </div>
                </div>

                <!-- Materials Section -->
                <div class="detail-section" *ngIf="job.jobData.materialsInfo">
                  <h4>Materials</h4>
                  <div class="detail-row">
                    <span class="label">Materials Info:</span>
                    <span class="value">{{ job.jobData.materialsInfo }}</span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Empty State -->
        <div *ngIf="activeJobs.size === 0" class="empty-state">
          <mat-icon>pending_actions</mat-icon>
          <h3>No Active Jobs</h3>
          <p>Trigger a workflow or custom mission to see active jobs here.</p>
        </div>
      </div>
    </mat-tab>

  </mat-tab-group>
</div>
