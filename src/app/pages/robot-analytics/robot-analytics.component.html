<div class="robot-analytics-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <mat-icon class="header-icon">analytics</mat-icon>
        <h1>Robot Analytics</h1>
      </div>
    </div>
  </div>

  <!-- Filters Card -->
  <mat-card class="filters-card">
    <div class="filters-header">
      <div class="filters-title">
        <mat-icon class="title-icon">filter_alt</mat-icon>
        <h2>Analysis Filters</h2>
      </div>
    </div>

    <div class="filters-content compact">
      <div class="filters-row">
        <!-- Robot Selection -->
        <div class="filter-item robot-select">
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Robot</mat-label>
            <mat-select [(value)]="selectedRobotId">
              <mat-option *ngFor="let robot of availableRobots" [value]="robot.id">
                {{ robot.name }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>smart_toy</mat-icon>
          </mat-form-field>
        </div>

        <!-- Start Date/Time -->
        <div class="filter-item datetime-compact">
          <mat-form-field appearance="outline" class="compact-field date-compact">
            <mat-label>Start Date</mat-label>
            <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate">
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>
          <mat-form-field appearance="outline" class="compact-field time-compact">
            <mat-label>Time</mat-label>
            <mat-select [(value)]="startHour">
              <mat-option *ngFor="let hour of hours" [value]="hour">{{ hour }}</mat-option>
            </mat-select>
          </mat-form-field>
          <span class="time-sep">:</span>
          <mat-form-field appearance="outline" class="compact-field min-compact">
            <mat-select [(value)]="startMinute">
              <mat-option *ngFor="let minute of minutes" [value]="minute">{{ minute }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <span class="range-arrow">â†’</span>

        <!-- End Date/Time -->
        <div class="filter-item datetime-compact">
          <mat-form-field appearance="outline" class="compact-field date-compact">
            <mat-label>End Date</mat-label>
            <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>
          <mat-form-field appearance="outline" class="compact-field time-compact">
            <mat-label>Time</mat-label>
            <mat-select [(value)]="endHour">
              <mat-option *ngFor="let hour of hours" [value]="hour">{{ hour }}</mat-option>
            </mat-select>
          </mat-form-field>
          <span class="time-sep">:</span>
          <mat-form-field appearance="outline" class="compact-field min-compact">
            <mat-select [(value)]="endMinute">
              <mat-option *ngFor="let minute of minutes" [value]="minute">{{ minute }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Grouping Toggle -->
        <div class="filter-item grouping-compact">
          <mat-button-toggle-group [(ngModel)]="groupBy" class="grouping-toggle-compact">
            <mat-button-toggle value="day">
              <mat-icon>today</mat-icon>
              Daily
            </mat-button-toggle>
            <mat-button-toggle value="hour">
              <mat-icon>schedule</mat-icon>
              Hourly
            </mat-button-toggle>
          </mat-button-toggle-group>
        </div>

        <!-- Actions -->
        <div class="filter-item actions-compact">
          <button mat-raised-button color="primary" class="search-btn" (click)="applyFilters()" [disabled]="!selectedRobotId || isLoading">
            <mat-icon>search</mat-icon>
            {{ isLoading ? 'Searching...' : 'Search' }}
          </button>
          <button mat-stroked-button class="reset-btn" (click)="resetFilters()" [disabled]="isLoading">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-progress-spinner mode="indeterminate" diameter="60"></mat-progress-spinner>
    <p class="loading-text">Loading analytics data...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error && !isLoading">
    <mat-icon>error_outline</mat-icon>
    <h3>Error Loading Data</h3>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="refreshData()">
      Try Again
    </button>
  </div>

  <!-- Initial State - Before Search -->
  <div class="empty-state" *ngIf="!hasSearched && !isLoading">
    <mat-icon>analytics</mat-icon>
    <h3>Select Filters and Search</h3>
    <p>Choose a robot and date range, then click Search to view analytics</p>
  </div>

  <!-- Empty State - After Search with No Data -->
  <div class="empty-state" *ngIf="hasSearched && !utilizationData && !isLoading && !error">
    <mat-icon>search_off</mat-icon>
    <h3>No Data Found</h3>
    <p>No analytics data available for the selected filters. Try adjusting the date range.</p>
  </div>

  <!-- Analytics Content -->
  <div *ngIf="hasSearched && utilizationData && !isLoading && !error">
    <!-- KPI Cards -->
    <div class="kpi-container">
      <mat-card class="kpi-card">
        <div class="kpi-content">
          <div class="kpi-icon utilization">
            <mat-icon>speed</mat-icon>
          </div>
          <div class="kpi-value large">{{ utilizationData?.summary?.averageUtilization ?? 0 | number:'1.1-1' }}%</div>
          <div class="kpi-label">Avg Utilization</div>
        </div>
      </mat-card>

      <mat-card class="kpi-card">
        <div class="kpi-content">
          <div class="kpi-icon working">
            <mat-icon>work</mat-icon>
          </div>
          <div class="kpi-value">{{ formatMinutes(utilizationData?.summary?.totalWorkingTime ?? 0) }}</div>
          <div class="kpi-label">Total Working</div>
          <div class="kpi-sublabel">{{ utilizationData?.summary?.totalWorkingTime ?? 0 }} minutes</div>
        </div>
      </mat-card>

      <mat-card class="kpi-card">
        <div class="kpi-content">
          <div class="kpi-icon charging">
            <mat-icon>battery_charging_full</mat-icon>
          </div>
          <div class="kpi-value">{{ formatMinutes(utilizationData?.summary?.totalChargingTime ?? 0) }}</div>
          <div class="kpi-label">Total Charging</div>
          <div class="kpi-sublabel">{{ utilizationData?.summary?.totalChargingTime ?? 0 }} minutes</div>
        </div>
      </mat-card>

      <mat-card class="kpi-card">
        <div class="kpi-content">
          <div class="kpi-icon idle">
            <mat-icon>pause_circle</mat-icon>
          </div>
          <div class="kpi-value">{{ formatMinutes(utilizationData?.summary?.totalIdleTime ?? 0) }}</div>
          <div class="kpi-label">Total Idle</div>
          <div class="kpi-sublabel">{{ utilizationData?.summary?.totalIdleTime ?? 0 }} minutes</div>
        </div>
      </mat-card>
    </div>

    <!-- Charts Container -->
    <div class="charts-container">
      <!-- Utilization Trend Line Chart -->
      <mat-card class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">Utilization Rate Trend</h3>
          <p class="chart-subtitle">Track robot utilization percentage over time</p>
        </div>
        <div class="chart-content">
          <div class="chart-wrapper tall">
            <canvas baseChart
                    [data]="utilizationChartData"
                    [options]="utilizationChartOptions"
                    [type]="'line'">
            </canvas>
          </div>
        </div>
      </mat-card>

      <!-- Time Distribution Stacked Area Chart -->
      <mat-card class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">Time Distribution</h3>
          <p class="chart-subtitle">Breakdown of working, charging, and idle time</p>
        </div>
        <div class="chart-content">
          <div class="chart-wrapper tall">
            <canvas baseChart
                    [data]="timeDistributionChartData"
                    [options]="timeDistributionChartOptions"
                    [type]="'line'">
            </canvas>
          </div>
        </div>
      </mat-card>
    </div>
  </div>
</div>
