<div class="robot-analytics-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <mat-icon class="header-icon">analytics</mat-icon>
        <h1>Robot Analytics</h1>
      </div>
    </div>
  </div>

  <!-- Filters Card -->
  <mat-card class="filters-card">
    <div class="filters-header">
      <div class="filters-title">
        <mat-icon class="title-icon">filter_alt</mat-icon>
        <h2>Analysis Filters</h2>
      </div>
      <button mat-icon-button (click)="filtersExpanded = !filtersExpanded" class="collapse-button">
        <mat-icon>{{ filtersExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
      </button>
    </div>

    <div class="filters-summary" *ngIf="!filtersExpanded">
      <div class="summary-item">
        <mat-icon>smart_toy</mat-icon>
        <span>{{ selectedRobotId ? 'Robot ' + selectedRobotId : 'No robot selected' }}</span>
      </div>
      <div class="summary-divider">|</div>
      <div class="summary-item">
        <mat-icon>event_note</mat-icon>
        <span>{{ startDate | date:'MMM dd, yyyy' }} {{ startHour }}:{{ startMinute }}</span>
      </div>
      <div class="summary-arrow">â†’</div>
      <div class="summary-item">
        <mat-icon>event</mat-icon>
        <span>{{ endDate | date:'MMM dd, yyyy' }} {{ endHour }}:{{ endMinute }}</span>
      </div>
      <div class="summary-divider">|</div>
      <div class="summary-item">
        <mat-icon>view_timeline</mat-icon>
        <span>{{ groupBy === 'day' ? 'Daily View' : 'Hourly View' }}</span>
      </div>
    </div>

    <div class="filters-content" *ngIf="filtersExpanded">
      <!-- Robot Selection -->
      <div class="filter-section">
        <div class="section-label">
          <mat-icon>smart_toy</mat-icon>
          <span>Robot Selection</span>
        </div>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Select Robot</mat-label>
          <mat-select [(value)]="selectedRobotId">
            <mat-option *ngFor="let robot of availableRobots" [value]="robot.id">
              <mat-icon class="option-icon">smart_toy</mat-icon>
              {{ robot.name }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>smart_toy</mat-icon>
        </mat-form-field>
      </div>

      <!-- Date and Time Range -->
      <div class="filter-section">
        <div class="section-label">
          <mat-icon>schedule</mat-icon>
          <span>Date & Time Range</span>
        </div>

        <div class="datetime-row">
          <!-- Start DateTime -->
          <div class="datetime-group start">
            <div class="datetime-label">
              <mat-icon>play_arrow</mat-icon>
              <span>Start</span>
            </div>
            <div class="datetime-fields">
              <mat-form-field appearance="outline" class="date-field">
                <mat-label>Date</mat-label>
                <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate">
                <mat-datepicker-toggle matPrefix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
              </mat-form-field>
              <div class="time-fields">
                <mat-form-field appearance="outline" class="time-field">
                  <mat-label>Hour</mat-label>
                  <mat-select [(value)]="startHour">
                    <mat-option *ngFor="let hour of hours" [value]="hour">{{ hour }}</mat-option>
                  </mat-select>
                  <mat-icon matPrefix>schedule</mat-icon>
                </mat-form-field>
                <span class="time-separator">:</span>
                <mat-form-field appearance="outline" class="time-field">
                  <mat-label>Min</mat-label>
                  <mat-select [(value)]="startMinute">
                    <mat-option *ngFor="let minute of minutes" [value]="minute">{{ minute }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </div>

          <!-- End DateTime -->
          <div class="datetime-group end">
            <div class="datetime-label">
              <mat-icon>stop</mat-icon>
              <span>End</span>
            </div>
            <div class="datetime-fields">
              <mat-form-field appearance="outline" class="date-field">
                <mat-label>Date</mat-label>
                <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate">
                <mat-datepicker-toggle matPrefix [for]="endPicker"></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
              </mat-form-field>
              <div class="time-fields">
                <mat-form-field appearance="outline" class="time-field">
                  <mat-label>Hour</mat-label>
                  <mat-select [(value)]="endHour">
                    <mat-option *ngFor="let hour of hours" [value]="hour">{{ hour }}</mat-option>
                  </mat-select>
                  <mat-icon matPrefix>schedule</mat-icon>
                </mat-form-field>
                <span class="time-separator">:</span>
                <mat-form-field appearance="outline" class="time-field">
                  <mat-label>Min</mat-label>
                  <mat-select [(value)]="endMinute">
                    <mat-option *ngFor="let minute of minutes" [value]="minute">{{ minute }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Grouping -->
      <div class="filter-section">
        <div class="section-label">
          <mat-icon>view_timeline</mat-icon>
          <span>Data Grouping</span>
        </div>
        <mat-button-toggle-group [(ngModel)]="groupBy" class="grouping-toggle">
          <mat-button-toggle value="day">
            <mat-icon>today</mat-icon>
            <span>Daily</span>
          </mat-button-toggle>
          <mat-button-toggle value="hour">
            <mat-icon>schedule</mat-icon>
            <span>Hourly</span>
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <!-- Search Actions -->
      <div class="filter-actions">
        <button mat-raised-button color="primary" class="search-button" (click)="applyFilters()" [disabled]="!selectedRobotId || isLoading">
          <mat-icon>search</mat-icon>
          <span>{{ isLoading ? 'Searching...' : 'Search Analytics' }}</span>
        </button>
        <button mat-stroked-button class="reset-button" (click)="resetFilters()" [disabled]="isLoading">
          <mat-icon>refresh</mat-icon>
          <span>Reset</span>
        </button>
      </div>
    </div>
  </mat-card>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-progress-spinner mode="indeterminate" diameter="60"></mat-progress-spinner>
    <p class="loading-text">Loading analytics data...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error && !isLoading">
    <mat-icon>error_outline</mat-icon>
    <h3>Error Loading Data</h3>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="refreshData()">
      Try Again
    </button>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!utilizationData && !isLoading && !error">
    <mat-icon>analytics</mat-icon>
    <h3>No Data Available</h3>
    <p>Select a robot and date range to view analytics</p>
    <button mat-raised-button color="primary" (click)="loadDefaultData()">
      Load Last 7 Days
    </button>
  </div>

  <!-- Analytics Content -->
  <div *ngIf="utilizationData && !isLoading && !error">
    <!-- KPI Cards -->
    <div class="kpi-container">
      <mat-card class="kpi-card">
        <div class="kpi-content">
          <div class="kpi-icon utilization">
            <mat-icon>speed</mat-icon>
          </div>
          <div class="kpi-value large">{{ utilizationData?.summary?.averageUtilization ?? 0 | number:'1.1-1' }}%</div>
          <div class="kpi-label">Avg Utilization</div>
        </div>
      </mat-card>

      <mat-card class="kpi-card">
        <div class="kpi-content">
          <div class="kpi-icon working">
            <mat-icon>work</mat-icon>
          </div>
          <div class="kpi-value">{{ formatMinutes(utilizationData?.summary?.totalWorkingTime ?? 0) }}</div>
          <div class="kpi-label">Total Working</div>
          <div class="kpi-sublabel">{{ utilizationData?.summary?.totalWorkingTime ?? 0 }} minutes</div>
        </div>
      </mat-card>

      <mat-card class="kpi-card">
        <div class="kpi-content">
          <div class="kpi-icon charging">
            <mat-icon>battery_charging_full</mat-icon>
          </div>
          <div class="kpi-value">{{ formatMinutes(utilizationData?.summary?.totalChargingTime ?? 0) }}</div>
          <div class="kpi-label">Total Charging</div>
          <div class="kpi-sublabel">{{ utilizationData?.summary?.totalChargingTime ?? 0 }} minutes</div>
        </div>
      </mat-card>

      <mat-card class="kpi-card">
        <div class="kpi-content">
          <div class="kpi-icon idle">
            <mat-icon>pause_circle</mat-icon>
          </div>
          <div class="kpi-value">{{ formatMinutes(utilizationData?.summary?.totalIdleTime ?? 0) }}</div>
          <div class="kpi-label">Total Idle</div>
          <div class="kpi-sublabel">{{ utilizationData?.summary?.totalIdleTime ?? 0 }} minutes</div>
        </div>
      </mat-card>
    </div>

    <!-- Charts Container -->
    <div class="charts-container">
      <!-- Utilization Trend Line Chart -->
      <mat-card class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">Utilization Rate Trend</h3>
          <p class="chart-subtitle">Track robot utilization percentage over time</p>
        </div>
        <div class="chart-content">
          <div class="chart-wrapper tall">
            <canvas baseChart
                    [data]="utilizationChartData"
                    [options]="utilizationChartOptions"
                    [type]="'line'">
            </canvas>
          </div>
        </div>
      </mat-card>

      <!-- Time Distribution Stacked Area Chart -->
      <mat-card class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">Time Distribution</h3>
          <p class="chart-subtitle">Breakdown of working, charging, and idle time</p>
        </div>
        <div class="chart-content">
          <div class="chart-wrapper tall">
            <canvas baseChart
                    [data]="timeDistributionChartData"
                    [options]="timeDistributionChartOptions"
                    [type]="'line'">
            </canvas>
          </div>
        </div>
      </mat-card>
    </div>
  </div>
</div>
